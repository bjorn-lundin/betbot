<!doctype html>
<html lang="se-sv">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="//code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/feather-icons/4.9.0/feather.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

<script>
    
//get timestamps in console log start
var origlog = console.log;

console.log = function( obj, ...placeholders ){
    var d = new Date();
    var n = d.toISOString();
    if ( typeof obj === 'string' )
        placeholders.unshift( n + " " + obj );
    else
    {
        // This handles console.log( object )
        placeholders.unshift( obj );
        placeholders.unshift( n + " %j" );
    }

    origlog.apply( this, placeholders );
};//get timestamps in console log stop
    
window.addEventListener('load', PageLoadComplete );    
    
    
function PageLoadComplete(){
  console.log("PageLoadComplete start");
  UpdateChart();
  console.log("PageLoadComplete stop");
}
    
var context = 'months'
var URL='http://lundin.duckdns.org'
var myChart = null;
var user = 'bnl';
var currentuser = '';

function Do_Login(usr) { // catch the form's submit event
      // Send data to server through the Ajax call
      // action is functionality we want to call and outputJSON is our data

      var params = 'username=' + usr;
      console.log("Do_Login: params" + params + "'");
      var xhr = new XMLHttpRequest();
      xhr.open('POST', URL + '/login', false); //synchronous
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send(params); 
      console.log('got:' +xhr.responseText);
}

function SetChartType(charttype) {
  if (charttype == "monthly") context = "months";  
  if (charttype == "weekly")  context = "weeks";  
  UpdateChart();
}

function SetUser(usr) {
  user = usr;
  UpdateChart();
}


function UpdateChart() {
  if (myChart != null) myChart.destroy();
  
  if (user != currentuser) {
    currentuser = user;
    Do_Login(user);
 }   
  
  feather.replace()
  // Graphs
  var ctx = document.getElementById('myChart')
  // eslint-disable-next-line no-unused-vars
  myChart = new Chart(ctx, {
    type: 'bar',
    data: {},
    options: {
        title: {
            display: true,
            text: "Not_Set"
        },    
        legend: {
            display: false
        },    
        responsive: true,
        scales: {
           xAxes: [{ stacked: true }],
           yAxes: [{ stacked: true }]
        },
        tooltips: {
            mode: 'nearest',
            callbacks: {
                label: function(tooltipItem, data) {
                    var strategy = data.datasets[tooltipItem.datasetIndex].label;
                    var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                    var total = 0;
                    for (var i = 0; i < data.datasets.length; i++)
                        total += data.datasets[i].data[tooltipItem.index];

                    return strategy + ' : ' + value.toFixed(2) + '   Totalt : ' + total.toFixed(2) ;    
                }
            }
        }
    },
  })

  var xhr3 = new XMLHttpRequest();
  var d = new Date();
  
  if (context == "months") myChart.options.title.text = "Månadsvis " + user;  
  if (context == "weeks")  myChart.options.title.text = "Veckovis " + user;   
  
  xhr3.open('GET', URL + '?milliseconds=' + d.getTime() + '&context=' + context);
  xhr3.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr3.onload = function() {
      if (xhr3.readyState == 4 && xhr3.status == 200) {
          var res = xhr3.responseText; 
          console.log(res);
          var j = JSON.parse(res);  
          myChart.data.labels = j.labels; //time/x-axis
          myChart.data.datasets = j.datasets;
          myChart.update();
      }
  };
  xhr3.send();
}

    
</script>
    <title>Betbot Statistics</title>
  </head>
  <body>
    
<!--
    <div style='display:inline-block; border: 1px solid #CCC; border-radius: 6px; -webkit-border-radius: 6px; -o-border-radius: 6px; position: relative; overflow: hidden; width: 310px; height: 450px;'><iframe src='https://spotthestation.nasa.gov/widget/widget.cfm?country=Sweden&region=None&city=Lund' width='310' height='450' frameborder='0' ></iframe>
    </div>
-->    
    
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
      <h1 class="h2">Dashboard</h1>
      <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="SetChartType('monthly');">Måndadsvis</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="SetChartType('weekly');">Veckovis</button>
        </div>

        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Användare
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <button type="button" class="dropdown-item"  onclick="SetUser('bnl');">Björn</button>
            <button type="button" class="dropdown-item" onclick="SetUser('jmb');">Joakim</button>
            <button type="button" class="dropdown-item" onclick="SetUser('msm');">Mats</button>
                        
          </div>
        </div>

      </div>
    </div>    
    <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas>
      
  </body>
</html>
